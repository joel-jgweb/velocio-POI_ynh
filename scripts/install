#!/bin/bash

# üî• Charger les helpers YunoHost (OBLIGATOIRE)
source /usr/share/yunohost/helpers || {
    echo "‚ùå Impossible de charger les helpers YunoHost."
    exit 1
}

# Arguments
app=$1
domain=$2
path=$3
is_public=${4:-1}

# Aller dans le r√©pertoire du d√©p√¥t clon√©
if [ -z "$YNH_APP_BASEDIR" ] || [ ! -d "$YNH_APP_BASEDIR" ]; then
    ynh_die "‚ùå YNH_APP_BASEDIR non d√©fini"
fi
cd "$YNH_APP_BASEDIR" || ynh_die "‚ùå Impossible de se d√©placer dans $YNH_APP_BASEDIR"

# V√©rifier que velocio-POI existe
if [ ! -d "velocio-POI" ]; then
    echo "‚ùå ERREUR : Dossier velocio-POI introuvable dans $(pwd)"
    ls -la
    ynh_die "Le code source est manquant. V√©rifiez que le d√©p√¥t contient le dossier velocio-POI/"
fi

# Variables
final_path="/var/www/$app"
src_dir="$final_path/velocio-POI"

# Nettoyer et cr√©er le dossier cible
ynh_secure_remove "$final_path"
mkdir -p "$final_path"

# Copier le code (pas de git clone !)
cp -r velocio-POI "$src_dir"

# V√©rifier requirements.txt
if [ ! -f "$src_dir/requirements.txt" ]; then
    ynh_die "‚ùå requirements.txt introuvable dans $src_dir"
fi

# Cr√©er l‚Äôenvironnement virtuel
python3 -m venv "$src_dir/venv"
source "$src_dir/venv/bin/activate"

# Installer les d√©pendances
ynh_script_progression --message="Installation des d√©pendances Python..."
pip install --upgrade pip > /dev/null 2>&1
if ! pip install -r "$src_dir/requirements.txt"; then
    ynh_die "‚ùå √âchec de l'installation des d√©pendances Python"
fi

# Cr√©er les dossiers utilisateur
mkdir -p /home/yunohost.app/.velocio_poi/cache
mkdir -p /home/yunohost.app/.velocio_poi/output
# Ne pas forcer chown ‚Üí YunoHost g√®re les droits

# Configurer uWSGI
ynh_uwsgi_configure --app_id="$app" --uwsgi_file="etc/uwsgi/apps-available/velocio-poi.ini"

# Configurer Nginx
ynh_nginx_configure --domain="$domain" --app_id="$app" --path="$path" --conf_file="conf/nginx.conf"

# Enregistrer les param√®tres
ynh_app_setting --app="$app" --key="domain" --value="$domain"
ynh_app_setting --app="$app" --key="path" --value="$path"
ynh_app_setting --app="$app" --key="is_public" --value="$is_public"

# Nettoyer
ynh_clean_setup

echo "‚úÖ Velocio Traces & Spots install√© avec succ√®s !"