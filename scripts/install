#!/bin/bash
# scripts/install

# Exit immédiatement si une commande échoue
set -euo pipefail

app=$1
domain=$2
path=$3

# === S'assurer qu'on est dans le bon répertoire ===
if [ -n "$YNH_APP_BASEDIR" ] && [ -d "$YNH_APP_BASEDIR" ]; then
    cd "$YNH_APP_BASEDIR" || exit 1
fi

# === Variables ===
final_path="/var/www/$app"
src_dir="$final_path/velocio-POI"

# === Créer le dossier cible ===
mkdir -p "$final_path"

# === Vérifier que velocio-POI existe ===
if [ ! -d "velocio-POI" ]; then
    echo "❌ ERREUR : Dossier velocio-POI introuvable dans $(pwd)"
    echo "Contenu actuel :"
    ls -la
    exit 1
fi

# === Copier le code ===
cp -r velocio-POI "$src_dir"

# === Aller dans le dossier de l'app ===
cd "$src_dir" || exit 1

# === Environnement virtuel ===
python3 -m venv venv
source venv/bin/activate

# === Installer les dépendances ===
if [ ! -f "requirements.txt" ]; then
    echo "❌ requirements.txt introuvable"
    exit 1
fi
pip install -r requirements.txt

# === Créer les dossiers utilisateur ===
mkdir -p ~/.velocio_poi/cache
mkdir -p ~/.velocio_poi/output
mkdir -p uploads

echo "✅ Velocio Traces & Spots installé avec succès !"