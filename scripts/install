#!/bin/bash
# scripts/install

app=$1
domain=$2
path=$3

# Ne pas activer set -euo pipefail tout de suite
# On attend d'avoir les arguments

# === Aller dans le bon répertoire ===
if [ -n "$YNH_APP_BASEDIR" ] && [ -d "$YNH_APP_BASEDIR" ]; then
    cd "$YNH_APP_BASEDIR" || {
        echo "❌ Impossible de se déplacer dans $YNH_APP_BASEDIR"
        exit 1
    }
fi

# === Vérifier que velocio-POI existe ===
if [ ! -d "velocio-POI" ]; then
    echo "❌ ERREUR : Dossier velocio-POI introuvable dans $(pwd)"
    echo "Contenu actuel :"
    ls -la
    exit 1
fi

# === Variables ===
final_path="/var/www/$app"

# === Créer le dossier cible ===
mkdir -p "$final_path"

# === Copier le code ===
cp -r velocio-POI "$final_path/"

# === Aller dans le dossier de l'app ===
cd "$final_path/velocio-POI" || {
    echo "❌ Impossible d'accéder à $final_path/velocio-POI"
    exit 1
}

# === Créer l'environnement virtuel ===
python3 -m venv venv
source venv/bin/activate

# === Installer les dépendances ===
if [ ! -f "requirements.txt" ]; then
    echo "❌ requirements.txt introuvable"
    exit 1
fi
pip install -r requirements.txt

# === Créer les dossiers utilisateur ===
mkdir -p ~/.velocio_poi/cache
mkdir -p ~/.velocio_poi/output
mkdir -p uploads

echo "✅ Velocio Traces & Spots installé avec succès !"