#!/bin/bash

# üî• Charger les helpers YunoHost
source /usr/share/yunohost/helpers || {
    echo "‚ùå Impossible de charger les helpers YunoHost."
    exit 1
}

# Arguments
app=$1
domain=$2
path=$3
is_public=${4:-1}

# V√©rifier que les arguments sont bien pass√©s
if [ -z "$app" ] || [ -z "$domain" ] || [ -z "$path" ]; then
    ynh_die "‚ùå Arguments manquants : app='$app', domain='$domain', path='$path'"
fi

# Aller dans le r√©pertoire du d√©p√¥t
if [ -z "$YNH_APP_BASEDIR" ] || [ ! -d "$YNH_APP_BASEDIR" ]; then
    ynh_die "‚ùå YNH_APP_BASEDIR non d√©fini"
fi
cd "$YNH_APP_BASEDIR" || ynh_die "‚ùå Impossible de se d√©placer dans $YNH_APP_BASEDIR"

# V√©rifier que velocio-POI existe
if [ ! -d "velocio-POI" ]; then
    echo "‚ùå ERREUR : Dossier velocio-POI introuvable dans $(pwd)"
    ls -la
    ynh_die "Le code source est manquant."
fi

# Variables
final_path="/var/www/$app"
src_dir="$final_path/velocio-POI"

# Nettoyer et cr√©er le dossier
ynh_secure_remove "$final_path"
mkdir -p "$final_path"

# Copier le code
cp -r velocio-POI "$src_dir"

# V√©rifier requirements.txt
if [ ! -f "$src_dir/requirements.txt" ]; then
    ynh_die "‚ùå requirements.txt introuvable"
fi

# Cr√©er l‚Äôenvironnement virtuel
python3 -m venv "$src_dir/venv"
source "$src_dir/venv/bin/activate"

# Installer les d√©pendances
ynh_script_progression --message="Installation des d√©pendances Python..."
pip install --upgrade pip > /dev/null 2>&1
if ! pip install -r "$src_dir/requirements.txt"; then
    ynh_die "‚ùå √âchec de l'installation des d√©pendances"
fi

# === üîß Cr√©er le fichier uWSGI MANUELLEMENT (nouvelle m√©thode) ===
cat << EOF > /etc/uwsgi/apps-available/$app.ini
[uwsgi]
project = $app
base = /var/www/\$project/velocio-POI
chdir = \$base/src
module = server:app
callable = app
virtualenv = \$base/venv
master = true
processes = 2
socket = /run/uwsgi/app/\$project/uwsgi.sock
chmod-socket = 666
vacuum = true
die-on-term = true
plugin = python3
EOF

# Activer uWSGI
ln -sf /etc/uwsgi/apps-available/$app.ini /etc/uwsgi/apps-enabled/$app.ini
systemctl reload uwsgi

# === üîß Cr√©er le vhost Nginx MANUELLEMENT ===
cat << EOF > /etc/nginx/conf.d/$domain.d/$app.conf
server {
    listen 80;
    server_name $domain;

    location $path/ {
        include uwsgi_params;
        uwsgi_pass unix:///run/uwsgi/app/$app/uwsgi.sock;
        uwsgi_param UWSGI_CHDIR /var/www/$app/velocio-POI/src;
        uwsgi_param UWSGI_SCRIPT server:app;
        uwsgi_param UWSGI_PYHOME /var/www/$app/velocio-POI/venv;
    }
}
EOF

# Recharger Nginx
systemctl reload nginx

# Cr√©er les dossiers utilisateur
mkdir -p /home/yunohost.app/.velocio_poi/cache
mkdir -p /home/yunohost.app/.velocio_poi/output

# Enregistrer les param√®tres
ynh_app_setting --app="$app" --key="domain" --value="$domain"
ynh_app_setting --app="$app" --key="path" --value="$path"
ynh_app_setting --app="$app" --key="is_public" --value="$is_public"

# Nettoyer
ynh_clean_setup

echo "‚úÖ Velocio Traces & Spots install√© avec succ√®s !"
