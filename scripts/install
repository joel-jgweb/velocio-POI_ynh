#!/bin/bash

# üî• Charger les helpers YunoHost
source /usr/share/yunohost/helpers || {
    echo "‚ùå Impossible de charger les helpers YunoHost. V√©rifiez que YunoHost est install√©."
    exit 1
}

# R√©cup√©rer les param√®tres via les variables d'environnement YunoHost
app=${YNH_APP_INSTANCE_NAME}
domain=${YNH_APP_ARG_DOMAIN}
path=${YNH_APP_ARG_PATH}
is_public=${YNH_APP_ARG_IS_PUBLIC}

# V√©rifications
[ -z "$app" ] && ynh_die "‚ùå Le nom de l'application (arg1) est manquant."
[ -z "$domain" ] && ynh_die "‚ùå Le domaine (arg2) est manquant."
[ -z "$path" ] && ynh_die "‚ùå Le chemin (arg3) est manquant."

# Chemins
final_path="/var/www/$app"
src_dir="$final_path/velocio-POI"

# Copier les fichiers
ynh_setup_source_tree
ynh_copy_source "velocio-POI" "$src_dir"

# Dossier utilisateur
user_data_dir="/home/yunohost.app/.velocio_poi"
mkdir -p "$user_data_dir"

# Enregistrer les param√®tres
ynh_app_setting_set --app="$app" --key="domain" --value="$domain"
ynh_app_setting_set --app="$app" --key="path" --value="$path"
ynh_app_setting_set --app="$app" --key="is_public" --value="$is_public"

# Permissions SSO
if [ "$is_public" = "yes" ]; then
    ynh_permission_update --app "$app" --perm main --allowed all_users
else
    ynh_permission_update --app "$app" --perm main --protected true
fi

# Nginx
ynh_nginx_generate_config
ynh_service_reload_or_restart nginx

# Nettoyer
ynh_clean_setup

echo "‚úÖ Velocio Traces & Spots install√© avec succ√®s sur http://$domain$path"