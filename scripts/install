#!/bin/bash

source /usr/share/yunohost/helpers || {
    echo "❌ Impossible de charger les helpers YunoHost."
    exit 1
}

# Récupérer les paramètres YunoHost
app=${YNH_APP_INSTANCE_NAME}
domain=${YNH_APP_ARG_DOMAIN}
path=${YNH_APP_ARG_PATH}
is_public=${YNH_APP_ARG_IS_PUBLIC}

[ -z "$app" ] && ynh_die "❌ Le nom de l'application est manquant."
[ -z "$domain" ] && ynh_die "❌ Le domaine est manquant."
[ -z "$path" ] && ynh_die "❌ Le chemin est manquant."

final_path="/var/www/$app"
src_dir="$final_path/velocio-POI"

# Copier les fichiers depuis le bon dossier sources
mkdir -p "$src_dir"
cp -a "../sources/." "$src_dir/" || echo "⚠️ Copie manuelle des fichiers, vérifiez le chemin source"

user_data_dir="/home/yunohost.app/.velocio_poi"
mkdir -p "$user_data_dir"

ynh_app_setting_set --app="$app" --key="domain" --value="$domain"
ynh_app_setting_set --app="$app" --key="path" --value="$path"
ynh_app_setting_set --app="$app" --key="is_public" --value="$is_public"

# Permissions SSO (utiliser le bon argument YunoHost)
if [[ "$is_public" == "yes" || "$is_public" == "1" ]]; then
    ynh_permission_update --app "$app" --permission main --public yes
else
    ynh_permission_update --app "$app" --permission main --public no
fi

ynh_nginx_generate_config
ynh_service_reload_or_restart nginx

ynh_clean_setup

echo "✅ Velocio Traces & Spots installé avec succès sur http://$domain$path"