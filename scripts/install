#!/bin/bash

# ğŸ”¥ Charger les helpers YunoHost (OBLIGATOIRE)
source /usr/share/yunohost/helpers || {
    echo "âŒ Impossible de charger les helpers YunoHost. VÃ©rifiez que YunoHost est installÃ©."
    exit 1
}

# ğŸ“¥ RÃ©cupÃ©ration des arguments passÃ©s par YunoHost
app="${1:-}"
domain="${2:-}"
path="${3:-}"
is_public="${4:-1}"

# âœ… VÃ©rification que le nom de l'application a bien Ã©tÃ© transmis
if [ -z "$app" ]; then
    ynh_die "âŒ Le nom de l'application (arg1) est manquant."
fi

# âœ… VÃ©rification que le domaine est fourni
if [ -z "$domain" ]; then
    ynh_die "âŒ Le domaine (arg2) est manquant."
fi

# âœ… VÃ©rification que le chemin est fourni
if [ -z "$path" ]; then
    ynh_die "âŒ Le chemin d'URL (arg3) est manquant."
fi

# ğŸ› ï¸ DÃ©but de l'installation
ynh_script_progression --message="Installation de Velocio Traces & Spots..."

# ğŸ“ DÃ©finir les chemins
final_path="/var/www/$app"
velocio_src="velocio-POI"

# ğŸ”§ CrÃ©er le rÃ©pertoire final
ynh_setup_source_tree
ynh_copy_source "$velocio_src" "$final_path"

# ğŸ—ï¸ CrÃ©er le dossier utilisateur si nÃ©cessaire
user_data_dir="$HOME/.velocio_poi"
mkdir -p "$user_data_dir"

# âš™ï¸ Enregistrer les paramÃ¨tres de l'application
ynh_app_setting --app="$app" --key="domain" --value="$domain"
ynh_app_setting --app="$app" --key="path" --value="$path"
ynh_app_setting --app="$app" --key="is_public" --value="$is_public"

# ğŸ” Rendre l'application accessible ou non aux anonymes
if [ "$is_public" = "yes" ]; then
    ynh_permission_update --app "$app" --perm main --allowed all_users
else
    ynh_permission_update --app "$app" --perm main --protected true
fi

# ğŸ”„ GÃ©nÃ©rer la configuration Nginx
ynh_nginx_generate_config

# ğŸ”„ RedÃ©marrer Nginx pour appliquer les changements
ynh_service_reload_or_restart nginx

# ğŸ§¹ Nettoyer le cache d'installation
ynh_clean_setup

# âœ… Message de succÃ¨s
echo "âœ… Velocio Traces & Spots installÃ© avec succÃ¨s sur http://$domain$path"